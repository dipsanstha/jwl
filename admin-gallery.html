<!DOCTYPE html>
<html lang="en">
 <head>
 <meta charset="UTF-8">
 <title>Gallery Admin - New Madi Jewellers</title>
 <link rel="preconnect" href="https://cdn.jsdelivr.net">
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body{font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; margin:0}
    .container{max-width:1100px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.08); overflow:hidden}
    header{padding:20px 24px; background:linear-gradient(135deg,#FFD700,#B8860B); color:#fff}
    header h1{margin:0; font-size:22px; font-weight:700}
    .item .meta h4{margin:0 0 6px; font-size:14px}
    .logout-btn{border:0; background:rgba(255,255,255,0.2); color:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .actions{display:flex; gap:8px; margin-top:8px}
    .note{font-size:12px; color:#666; margin-top:8px}
    .status{margin-bottom:12px; font-size:13px}

    /* Admin Layout & Components */
    .content{padding:20px 24px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:20px; align-items:start}
    .card{background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid #eee}
    .card h2{margin:0 0 12px; font-size:18px; color:#222; display:flex; align-items:center; gap:8px}
    label{display:block; font-size:12px; color:#5a5f69; margin:10px 0 6px}
    input[type="text"], textarea, select, input[type="file"]{width:100%; padding:10px 12px; border:1px solid #e0e3e8; border-radius:10px; font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; font-size:14px}
    textarea{resize:vertical}
    button{background:linear-gradient(135deg,#FFD700,#B8860B); color:#111; border:0; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer}
    button.secondary{background:#f2f4f7; color:#222; border:1px solid #e0e3e8}
    button:disabled{opacity:.6; cursor:not-allowed}
    .list{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px}
    .item{background:#fafafa; border-radius:12px; overflow:hidden; border:1px solid #eee; display:flex; flex-direction:column}
    .item img{width:100%; height:180px; object-fit:cover; background:#ddd}
    .item .meta{padding:10px}
    .badge{display:inline-block; font-size:10px; letter-spacing:.2em; text-transform:uppercase; padding:4px 8px; border-radius:999px; border:1px solid #e0e3e8; color:#666}

    /* Toast notification */
    .toast{position:fixed; top:18px; right:18px; z-index:2000; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.12); border:1px solid #eee; background:#fff; color:#111; font-size:14px; opacity:0; transform:translateY(-8px); animation:toastIn .25s ease forwards}
    .toast.success{border-color:#daf5d7}
    .toast.error{border-color:#ffd3d3}
    .toast i{opacity:.9}
    @keyframes toastIn{to{opacity:1; transform:translateY(0)}}
    @keyframes toastOut{to{opacity:0; transform:translateY(-8px)}}

    /* Smooth reveal */
    .fade-in{animation:fadeIn .25s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    /* Modern Auth Overlay */
    .auth-overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, rgba(255,215,0,0.08), rgba(184,134,11,0.12)); padding:20px; z-index:1000}
    .auth-card{width:100%; max-width:860px; background:#fff; border-radius:16px; box-shadow:0 22px 70px rgba(0,0,0,0.12); border:1px solid #eee; overflow:hidden; font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .auth-layout{display:grid; grid-template-columns: 1.2fr 1fr; min-height: 420px}
    .auth-media{background: url('images/p2.png') center/cover no-repeat; position:relative}
    .auth-media::after{content:''; position:absolute; inset:0; background:linear-gradient(135deg, rgba(0,0,0,0.05), rgba(0,0,0,0.2))}
    .auth-brand{position:absolute; top:16px; left:16px; display:flex; align-items:center; gap:10px; z-index:1}
    .auth-brand img{width:36px; height:36px; border-radius:8px}
    .auth-brand span{color:#fff; font-weight:700; text-shadow:0 1px 6px rgba(0,0,0,0.3)}
    .auth-form{padding:26px 24px 20px}
    .auth-form h2{margin:0 0 8px; color:#111; font-size:24px; letter-spacing:.2px}
    .auth-form p{margin:0 0 16px; color:#60646c; font-size:13px}
    .auth-form .field{margin:12px 0}
    .auth-form label{font-size:12px; color:#5a5f69; margin-bottom:6px; display:block; font-weight:600}
    .auth-form input{width:100%; padding:13px 14px; border:1px solid #e0e3e8; border-radius:12px; font-size:14px; font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; transition:border-color .2s ease, box-shadow .2s ease}
    .auth-form input::placeholder{color:#98a2b3}
    .auth-form input:focus{outline:none; border-color:#bfa35a; box-shadow:0 0 0 4px rgba(191,163,90,0.18)}
    .auth-inline{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px}
    .auth-small{font-size:12px; color:#666; display:flex; align-items:center; gap:8px}
    .auth-error{color:#b00020; font-size:12px; margin-top:8px; min-height:16px}
    .caps-hint{font-size:11px; color:#9a6b00; margin-top:6px; display:none}
    .auth-actions{display:flex; gap:10px; margin-top:12px}
    .auth-actions button{flex:1 1 auto; font-family:'Poppins', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; border-radius:12px}
    #loginBtn{background:linear-gradient(135deg,#FFD700,#B8860B); color:#111; border:0; padding:12px 14px; box-shadow:0 10px 24px rgba(184,134,11,0.25); transition:transform .15s ease, box-shadow .15s ease}
    #loginBtn:hover{transform:translateY(-2px); box-shadow:0 14px 30px rgba(184,134,11,0.35)}
    #authCancelBtn{background:#eef1f5; color:#333; border:1px solid #e0e3e8; padding:12px 14px}
    
    /* Responsive adjustments */
    @media (max-width: 900px){
      .container{margin:20px 12px}
      .row{grid-template-columns: 1fr; gap:16px}
      header h1{font-size:20px}
    }
    @media (max-width: 600px){
      .content{padding:16px}
      .card{padding:14px}
      .list{grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:12px}
      .actions{flex-wrap:wrap}
      .actions button{flex:1 1 auto}
      button{padding:10px 12px}
    }
  </style>
</head>
<body>
  

  <div class="container" id="adminContainer" style="display:none">
    <header style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <h1 style="display:flex; align-items:center; gap:8px;"><i class="fas fa-images"></i> Gallery Admin</h1>
      <div class="right" style="gap:14px;">
        <span id="whoami" style="font-size:13px; opacity:.9"></span>
        <button class="logout-btn" id="logoutBtn" title="Logout"><i class="fas fa-right-from-bracket"></i> Logout</button>
      </div>
    </header>
    <div class="content">
      <div class="row">
        <div class="card">
          <h2><i class="fas fa-upload"></i> Upload New Image</h2>
          <div class="status" id="status"></div>
          <label>Title</label>
          <input type="text" id="title" placeholder="e.g., Bridal Set">
          <label>Description</label>
          <textarea id="description" rows="3" placeholder="Optional"></textarea>
          <label>Category</label>
          <select id="category">
            <option value="all">All</option>
            <option value="gold">Gold</option>
            <option value="silver">Silver</option>
            <option value="diamond">Diamond</option>
            <option value="bridal">Bridal</option>
            <option value="traditional">Traditional</option>
          </select>
          <label>Image file</label>
          <input type="file" id="file" accept="image/*">
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
            <button id="uploadBtn"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
            <button class="secondary" id="refreshBtn"><i class="fas fa-sync"></i> Refresh</button>
            <button class="secondary" id="normalizeBtn" title="Copy files into uploads/ and fix URLs"><i class="fas fa-tools"></i> Normalize URLs</button>
          </div>
          <div class="note">Images are served from <code>/static-images/</code>. Recommended size: 800x800px+.</div>
        </div>
        <div class="card">
          <h2 style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <span><i class="fas fa-list"></i> Current Images</span>
            <span style="display:flex; gap:8px; align-items:center;">
              <button class="secondary" id="selectAllBtn" title="Toggle select all"><i class="fas fa-check-square"></i> Select All</button>
              <button class="secondary" id="deleteSelectedBtn" disabled title="Delete selected images"><i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)</button>
              <button class="secondary" id="deleteAllBtn" title="Delete ALL images"><i class="fas fa-skull-crossbones"></i> Delete All</button>
            </span>
          </h2>
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const isFile = location.protocol === 'file:';
    const isLocalhost = ['localhost','127.0.0.1'].includes(location.hostname);
    let API_BASE = (isFile || isLocalhost) ? 'http://localhost:3001' : location.origin;

    const el = id => document.getElementById(id);

    // --- Auth Helpers (Server-side via JWT cookie) ---
    async function serverMe(){
      try{
        const res = await fetch(API_BASE + '/api/auth/me', { credentials: 'include' });
        if (!res.ok) return null;
        const data = await res.json();
        return data && data.authenticated ? data.user : null;
      }catch{return null}
    }
    async function serverLogin(username, password){
      const res = await fetch(API_BASE + '/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });
      if (!res.ok){
        try{
          const errJson = await res.json();
          throw new Error(errJson.error || errJson.message || ('Login failed ('+res.status+')'));
        }catch{
          const txt = await res.text();
          throw new Error(txt || ('Login failed ('+res.status+')'));
        }
      }
      return res.json();
    }
    async function serverLogout(){
      try{ await fetch(API_BASE + '/api/auth/logout', { method: 'POST', credentials: 'include' }); }catch{}
    }

    function showAuth(){
      // Redirect to dedicated login page
      window.location.href = 'login.html';
    }
    function showAdmin(){
      const cont = el('adminContainer');
      cont.style.display = '';
      cont.classList.add('fade-in');
      const who = window.__whoami || 'admin';
      const whoEl = el('whoami');
      if (whoEl) whoEl.textContent = `Signed in as: ${who}`;
      // Focus first field for quick action
      setTimeout(()=>{ try{ el('title')?.focus(); }catch{} }, 50);
    }

    async function loadList(){
      el('list').innerHTML = '<div class="note">Loading...</div>';
      try{
        const res = await fetch(API_BASE + '/api/gallery', { cache: 'no-cache', credentials: 'include' });
        const data = await res.json();
        const images = Array.isArray(data.images) ? data.images : [];
        if (!images.length){
          el('list').innerHTML = '<div class="note">No images yet.</div>';
          return;
        }

        // Build safe image URL (handles spaces and relative paths)
        const makeSrc = (u) => {
          try{
            if (!u) return '';
            if (/^https?:\/\//i.test(u)) return u; // already absolute
            return new URL(u, API_BASE).href; // resolves and encodes
          }catch(e){
            // Fallback: manual join + encode spaces
            const joined = (u.startsWith('/') ? API_BASE + u : API_BASE + '/' + u);
            return joined.replace(/\s/g, '%20');
          }
        };

        el('list').innerHTML = images.map(img => {
          const src = makeSrc(img.url);
          return `
          <div class="item" data-id="${img.id}">
            <img src="${src}" alt="${img.title || ''}" onerror="this.onerror=null;this.src='${API_BASE}/static-images/photo.svg'">
            <div class="meta">
              <h4>${img.title || 'Untitled'}</h4>
              <div class="badge">
                ${img.category || 'all'}
              </div>
              <div class="actions" style="align-items:center; gap:10px; display:flex; flex-wrap:wrap;">
                <label style="display:flex; align-items:center; gap:6px; font-size:12px;">
                  <input type="checkbox" class="select-item" data-id="${img.id}"> Select
                </label>
                <button class="secondary" onclick="del('${img.id}')"><i class="fas fa-trash"></i> Delete</button>
                <a href="${src}" target="_blank"><button class="secondary"><i class="fas fa-external-link-alt"></i> Open</button></a>
              </div>
            </div>
          </div>
        `}).join('');

        // Wire selection handlers
        const selected = new Set();
        function updateSelectedUI(){
          el('selectedCount').textContent = String(selected.size);
          el('deleteSelectedBtn').disabled = selected.size === 0;
        }
        el('list').querySelectorAll('.select-item').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const id = e.target.getAttribute('data-id');
            if (e.target.checked) selected.add(id); else selected.delete(id);
            updateSelectedUI();
          });
        });
        el('selectAllBtn').onclick = () => {
          const all = Array.from(el('list').querySelectorAll('.select-item'));
          const allChecked = all.every(cb => cb.checked);
          all.forEach(cb => { cb.checked = !allChecked; cb.dispatchEvent(new Event('change')); });
        };
        el('deleteSelectedBtn').onclick = async () => {
          if (!selected.size) return;
          if (!confirm(`Delete ${selected.size} image(s)?`)) return;
          try{
            // Delete one by one to keep API simple
            for (const id of selected){
              await fetch(API_BASE + '/api/gallery/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
            }
            await loadList();
          }catch(e){
            alert('Delete selected failed: ' + e.message);
          }
        };

        el('deleteAllBtn').onclick = async () => {
          if (!confirm('Delete ALL images? This cannot be undone.')) return;
          try{
            await fetch(API_BASE + '/api/gallery', { method: 'DELETE', credentials: 'include' });
            await loadList();
          }catch(e){
            alert('Delete all failed: ' + e.message);
          }
        };
      }catch(e){
        el('list').innerHTML = '<div class="note" style="color:#c00">Failed to load list. Make sure the API is running at http://localhost:3001 (npm start in server/).</div>';
      }
    }

    async function upload(){
      const file = el('file').files[0];
      if (!file){ el('status').textContent = 'Please choose an image file.'; return; }
      const fd = new FormData();
      fd.append('image', file);
      fd.append('title', el('title').value);
      fd.append('description', el('description').value);
      fd.append('category', el('category').value || 'all');
      el('uploadBtn').disabled = true;
      el('status').textContent = 'Uploading...';
      try{
        const res = await fetch(API_BASE + '/api/gallery', { method: 'POST', body: fd, credentials: 'include' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Upload failed');
        el('status').textContent = 'Uploaded successfully!';
        el('file').value = '';
        await loadList();
      }catch(e){
        el('status').textContent = 'Error: ' + e.message;
      }finally{
        el('uploadBtn').disabled = false;
      }
    }

    async function normalize(){
      el('status').textContent = 'Normalizing...';
      try{
        const res = await fetch(API_BASE + '/api/gallery/normalize', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Normalize failed');
        el('status').textContent = `Normalized ${data.results.filter(r=>r.action==='migrated').length} item(s).`;
        await loadList();
      }catch(e){
        el('status').textContent = 'Error: ' + e.message;
      }
    }

    async function del(id){
      if (!confirm('Delete this image?')) return;
      try{
        const res = await fetch(API_BASE + '/api/gallery/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Delete failed');
        await loadList();
      }catch(e){
        alert('Error: ' + e.message);
      }
    }

    async function init(){
      // Load config (api)
      try{
        const res = await fetch('data/config.json', { cache: 'no-cache' });
        if (res.ok){
          const cfg = await res.json();
          if (cfg && typeof cfg.apiBase === 'string' && cfg.apiBase.trim()){
            API_BASE = cfg.apiBase.trim().replace(/\/$/, '');
          }
        }
      }catch(e){ /* ignore missing config */ }

      // Logout -> go to login page
      el('logoutBtn').addEventListener('click', async () => {
        try{ await serverLogout(); }catch{}
        window.location.href = 'login.html';
      });

      // Gate admin with server session; otherwise send to login page
      const me = await serverMe();
      if (me && me.username){
        window.__whoami = me.username;
        showAdmin();
        wireAdmin();
        await loadList();
      } else {
        showAuth();
        return;
      }
    }

    function wireAdmin(){
      // Bind once safely
      if (!window.__adminWired){
        window.__adminWired = true;
        window.del = del;
        el('uploadBtn').addEventListener('click', upload);
        el('refreshBtn').addEventListener('click', loadList);
        el('normalizeBtn').addEventListener('click', normalize);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
